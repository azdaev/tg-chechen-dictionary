package ai

import (
	"context"
	"fmt"
	"strings"
)

// FormatDictionaryEntry formats a raw dictionary entry using AI.
// Returns formatted text optimized for readability in Telegram.
func (c *Client) FormatDictionaryEntry(ctx context.Context, rawEntry string) (string, error) {
	// Escape any existing quotes in the entry
	escapedEntry := strings.ReplaceAll(rawEntry, `"`, `\"`)

	prompt := `–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π —Å–ª–æ–≤–∞—Ä–Ω—É—é —Å—Ç–∞—Ç—å—é —á–µ—á–µ–Ω—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram-–±–æ—Ç–µ.

–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
"` + escapedEntry + `"

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Æ:
1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫**: —Å–ª–æ–≤–æ ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –ø–µ—Ä–µ–≤–æ–¥ (–±–µ–∑ –∂–∏—Ä–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞)
2. **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π**: –µ—Å–ª–∏ –µ—Å—Ç—å 1), 2), 3) ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —á–µ—Ä–µ–∑ —ç–º–æ–¥–∑–∏ —Ü–∏—Ñ—Ä (1Ô∏è‚É£ 2Ô∏è‚É£ 3Ô∏è‚É£) —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏ –≤ —Å–∫–æ–±–∫–∞—Ö
3. **–ü—Ä–∏–º–µ—Ä—ã**: –ø–æ–¥ –∫–∞–∂–¥—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º —Å –æ—Ç—Å—Ç—É–ø–æ–º —á–µ—Ä–µ–∑ ‚Ä¢ (bullet point)
4. **–¢–∏–ª—å–¥–∞ (~)**: –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–ª–æ–≤–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ
5. **–ß–∏—Å—Ç–æ—Ç–∞**: —É–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ –ø–æ–º–µ—Ç—ã, —Å–∫–æ–±–∫–∏, —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –µ—Å–ª–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
6. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ**: –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–ü–†–ò–ú–ï–† –í–•–û–î–ê:
**—á—ë—Ä–Ω—ã–π** - –∞—è, -–æ–µ ”è. –≤ —Ä–∞–∑–Ω. –∑–Ω–∞—á. ”è–∞—å—Ä–∂–∞; ~–æ–µ –ø–ª–∞—Ç—å–µ - ”è–∞—å—Ä–∂–∞ –∫–æ—á; ~—ã–π —Ö–ª–µ–± - ”è–∞—å—Ä–∂–∞ –±–µ–ø–∏–≥; ~–∞—è —Ä–∞–±–æ—Ç–∞ - ”è–∞—å—Ä–∂–∞ –±–æ–ª—Ö; ~–∞—è –±—É—Ä—è - –ª–∞—å—Ç—Ç–∞–Ω –¥–∞—Ä—Ü 2. –≤ –∑–Ω–∞—á. —Å—É—â. ~–æ–µ —Å ”è–∞—å—Ä–∂–∞ –±–µ–¥–∞—Ä; —Ö–æ–¥–∏—Ç—å –≤ ~–æ–º - ”è–∞—å—Ä–∂–∞ –¥—É—Ö–∞—Ä –ª–µ–ª–æ 3. –≤ –∑–Ω–∞—á. —Å—É—â. ~—ã–µ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ) (—à–∞—à–∫–∏ –∏ —Ç. –ø.) ”è–∞—å—Ä–∂–∞–Ω–∞—à

–ü–†–ò–ú–ï–† –í–´–•–û–î–ê:
—á—ë—Ä–Ω—ã–π ‚Äî ”è–∞—å—Ä–∂–∞

1Ô∏è‚É£ (–≤ —Ä–∞–∑–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö)
   ‚Ä¢ —á—ë—Ä–Ω–æ–µ –ø–ª–∞—Ç—å–µ ‚Üí ”è–∞—å—Ä–∂–∞ –∫–æ—á
   ‚Ä¢ —á—ë—Ä–Ω—ã–π —Ö–ª–µ–± ‚Üí ”è–∞—å—Ä–∂–∞ –±–µ–ø–∏–≥
   ‚Ä¢ —á—ë—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Üí ”è–∞—å—Ä–∂–∞ –±–æ–ª—Ö
   ‚Ä¢ —á—ë—Ä–Ω–∞—è –±—É—Ä—è ‚Üí –ª–∞—å—Ç—Ç–∞–Ω –¥–∞—Ä—Ü

2Ô∏è‚É£ (—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ)
   ‚Ä¢ —á—ë—Ä–Ω–æ–µ ‚Üí ”è–∞—å—Ä–∂–∞ –±–µ–¥–∞—Ä
   ‚Ä¢ —Ö–æ–¥–∏—Ç—å –≤ —á—ë—Ä–Ω–æ–º ‚Üí ”è–∞—å—Ä–∂–∞ –¥—É—Ö–∞—Ä –ª–µ–ª–æ

3Ô∏è‚É£ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ)
   ‚Ä¢ —á—ë—Ä–Ω—ã–µ (—à–∞—à–∫–∏) ‚Üí ”è–∞—å—Ä–∂–∞–Ω–∞—à

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`

	content, err := c.complete(ctx, []message{
		{Role: "user", Content: prompt},
	})
	if err != nil {
		return "", fmt.Errorf("ai format failed: %w", err)
	}

	// Clean up the response
	formatted := strings.TrimSpace(content)
	
	// Remove markdown code blocks if present
	formatted = strings.TrimPrefix(formatted, "```")
	formatted = strings.TrimSuffix(formatted, "```")
	formatted = strings.TrimSpace(formatted)

	return formatted, nil
}

// SpellCheck checks and corrects Chechen text using AI.
// Returns the corrected text and explanation of changes.
func (c *Client) SpellCheck(ctx context.Context, text string) (string, error) {
	prompt := `–¢—ã ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä —á–µ—á–µ–Ω—Å–∫–æ–≥–æ —è–∑—ã–∫–∞. –ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –Ω–∞ —á–µ—á–µ–Ω—Å–∫–æ–º –∏ –∏—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏.

–¢–ï–ö–°–¢:
"` + strings.ReplaceAll(text, `"`, `\"`) + `"

–ü–†–ê–í–ò–õ–ê:
1. –ò—Å–ø—Ä–∞–≤—å –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
2. –ò—Å–ø—Ä–∞–≤—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –±—É–∫–≤ (”è, –∞—å, –æ—å, —É—å, —é—å, —è—å, —Ö—å, –∫—Ö, –≥”è, etc.)
3. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ ‚Äî –Ω–∞–ø–∏—à–∏ "–≠—Ç–æ –Ω–µ —á–µ—á–µ–Ω—Å–∫–∏–π —Ç–µ–∫—Å—Ç"
4. –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç ‚Äî –Ω–∞–ø–∏—à–∏ "‚úÖ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ï—Å–ª–∏ –µ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
‚úèÔ∏è <–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç>

üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è:
‚Ä¢ <—á—Ç–æ –±—ã–ª–æ> ‚Üí <—á—Ç–æ —Å—Ç–∞–ª–æ> ‚Äî <–ø–æ—á–µ–º—É>

–ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç:
‚úÖ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ—Ç–≤–µ—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.`

	content, err := c.complete(ctx, []message{
		{Role: "user", Content: prompt},
	})
	if err != nil {
		return "", fmt.Errorf("ai spellcheck failed: %w", err)
	}

	return strings.TrimSpace(content), nil
}
