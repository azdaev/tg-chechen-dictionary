# AI Formatting для словаря

## Описание

Добавлена интеграция с OpenRouter (gemini-flash) для автоматического форматирования словарных статей.

## Как работает

1. Когда пользователь ищет слово, бот:
   - Проверяет Redis → БД → API
   - Если нашёл в API, сохраняет в БД с `is_approved=1`
   - **Асинхронно** форматирует через AI
   - Сохраняет результат AI в поле `formatted_ai`

2. Форматирование не блокирует ответ пользователю — происходит в фоне

3. В будущем на модерации будет показываться:
   - Legacy форматирование (текущее через FormatTranslationLite)
   - AI форматирование (более читаемое)
   - Модератор выбирает лучший → сохраняется в `formatted_chosen`

## Настройка

### Переменные окружения

```env
OPENROUTER_API_KEY=sk-or-v1-xxx...
OPENROUTER_MODEL=google/gemini-3-flash-preview
```

Если `OPENROUTER_API_KEY` не указан — AI форматирование отключается, бот работает как обычно.

## БД изменения

Новая миграция: `20260216000001_add_ai_formatting.sql`

Добавлены поля:
- `formatted_ai` TEXT — результат AI форматирования
- `formatted_chosen` TEXT — выбранный модератором вариант
- `format_version` TEXT — версия форматирования (legacy/ai_v1)

## Структура

```
internal/ai/
├── client.go      # OpenRouter API клиент (адаптирован из dostigator)
└── formatter.go   # Промпт для форматирования словаря
```

## Пример промпта

```
Отформатируй словарную статью чеченского словаря для отображения в Telegram-боте.

Вход: "**чёрный** - ая, -ое ӏ. в разн. знач. ӏаьржа..."

Выход:
чёрный — ӏаьржа
• чёрное платье → ӏаьржа коч
• чёрный хлеб → ӏаьржа бепиг
```

## TODO

- [ ] Интерфейс модерации с выбором формата (legacy vs AI)
- [ ] A/B тестирование форматов с пользователями
- [ ] Метрики качества (feedback от юзеров)
